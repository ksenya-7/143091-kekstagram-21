(()=>{"use strict";(()=>{const e=(e,t)=>Math.floor(e+Math.random()*(t+1-e));window.util={isEscape:e=>"Escape"===e.key,isEnter:e=>"Enter"===e.key,getRandom:e,getRandomFrom:t=>t[e(0,t.length-1)],createErrorMessage:e=>{let t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="15px",t.style.color="red",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},shuffleArray:e=>{for(let t=e.length-1;t>0;t--){const o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}return e}}})(),(()=>{let e;window.debounce=t=>{e&&window.clearTimeout(e),e=window.setTimeout(t,500)}})(),(()=>{const e="https://21.javascript.pages.academy/kekstagram/data",t="https://21.javascript.pages.academy/kekstagram";window.backend={load:(t,o)=>{const r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(()=>{let e;switch(r.status){case 200:t(r.response);break;case 400:e="Неверный запрос";break;case 401:e="Пользователь не авторизован";break;case 404:e="Ничего не найдено";break;default:e="Cтатус ответа: : "+r.status+" "+r.statusText}e&&o(e)})),r.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),r.addEventListener("timeout",(()=>{o("Запрос не успел выполниться за "+r.timeout+"мс")})),r.timeout=1e4,r.open("GET",e),r.send()},save:(e,o)=>{const r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(()=>{o(r.response)})),r.addEventListener("error",(()=>{window.successError.openErrorMessage()})),r.open("POST",t),r.send(e)}}})(),(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector(".comments-loader"),o=e.querySelector(".social__comments"),r=e.querySelector("#picture-cancel"),s=o.querySelector(".social__comment").cloneNode(!0),n=e=>{const t=s.cloneNode(!0);return t.querySelector(".social__picture").src=e.avatar,t.querySelector(".social__picture").alt=e.name,t.querySelector(".social__picture").width="35",t.querySelector(".social__picture").height="35",t.querySelector(".social__text").textContent=e.message,t.classList.add("hidden"),t};window.renderBigPicture=s=>{e.querySelector("img").src=s.url,e.querySelector("img").alt=s.description,e.querySelector(".social__caption").textContent=s.description,e.querySelector(".likes-count").textContent=s.likes,e.querySelector(".comments-count").textContent=s.comments.length,o.innerHTML="",s.comments.map(n).forEach((e=>o.append(e))),t.classList.remove("hidden");let c=[];c=s.comments;const l=(e,t)=>{for(let o=0;o<e;o++)t[o].classList.remove("hidden")},a=o.querySelectorAll(".social__comment");let i=5;const d=(e,o,r)=>{e<o.length?(l(e,r),t.classList.remove("hidden")):(l(o.length,r),t.classList.add("hidden"))};d(i,a,a),t.addEventListener("click",(()=>{i+=5,d(i,c,a)})),e.querySelector(".social__comment-count").classList.add("hidden"),document.querySelector("body").classList.add("modal-open"),e.classList.remove("hidden");const u=t=>{window.util.isEscape(t)&&document.querySelector("body").classList.remove("modal-open"),e.classList.add("hidden")};return r.addEventListener("click",(()=>{e.classList.add("hidden"),document.removeEventListener("keydown",u),document.querySelector("body").classList.remove("modal-open")})),document.addEventListener("keydown",u),e}})(),(()=>{const e=document.querySelector("#picture").content.querySelector(".picture");window.renderPicture=t=>{const o=e.cloneNode(!0);return o.querySelector(".picture__img").src=t.url,o.querySelector(".picture__likes").textContent=t.likes,o.querySelector(".picture__comments").textContent=t.comments.length,o}})(),(()=>{const e=document.querySelector("body"),t=document.querySelector(".pictures"),o=document.querySelector(".img-filters"),r=o.querySelectorAll(".img-filters__button"),s=e=>{let t=0;return t+=e.comments.length,t},n=o=>{(e=>{const o=document.createDocumentFragment();e.map(window.renderPicture).forEach((e=>o.append(e))),t.append(o)})(o),e.classList.remove("modal-open"),((e,t)=>{for(let o=0;o<e.length;o++)e[o].addEventListener("click",(()=>{window.renderBigPicture(t[o])}))})(t.querySelectorAll(".picture"),o)},c={"filter-default":e=>{const t=(e=>e.slice())(e);a(),l(r),window.debounce(n(t))},"filter-random":e=>{const t=((e,t)=>window.util.shuffleArray(e.slice()).slice(0,10))(e);a(),l(r),window.debounce(n(t))},"filter-discussed":e=>{const t=(e=>e.slice().sort(((e,t)=>s(t)-s(e))))(e);a(),l(r),window.debounce(n(t))}},l=e=>{for(let t of e)t.classList.remove("img-filters__button--active")},a=()=>{t.querySelectorAll(".picture").forEach((e=>e.remove())),e.classList.remove("modal-open")};let i=[];window.successHandler=e=>{i=e,n(i),o.classList.remove("img-filters--inactive"),(e=>{for(let t of r)t.addEventListener("click",(o=>{c[o.target.id](e),t.classList.add("img-filters__button--active")}))})(i)}})(),(()=>{const e=document.querySelector(".img-upload__preview"),t=document.querySelectorAll(".effects__preview"),o=document.querySelectorAll(".effects__label"),r=document.querySelector(".img-upload__effect-level"),s=r.querySelector(".effect-level__value"),n=document.querySelector(".effect-level__pin"),c={none:()=>{i="none",e.classList.add("effects__preview--none"),r.style.display="none",e.style.filter="none"},chrome:()=>{i="chrome",e.classList.add("effects__preview--chrome"),e.style.filter="grayscale(1)",r.style.display="block"},sepia:()=>{i="sepia",e.classList.add("effects__preview--sepia"),e.style.filter="sepia(1)",r.style.display="block"},marvin:()=>{i="marvin",e.classList.add("effects__preview--marvin"),e.style.filter="invert(100%)",r.style.display="block"},phobos:()=>{i="phobos",e.classList.add("effects__preview--phobos"),e.style.filter="blur(3px)",r.style.display="block"},heat:()=>{i="heat",e.classList.add("effects__preview--heat"),e.style.filter="brightness(3)",r.style.display="block"}},l={none:()=>"none",chrome:e=>`grayscale(${e/100})`,sepia:e=>`sepia(${e/100})`,marvin:e=>`invert(${e}%)`,phobos:e=>`blur(${1+e/100*2}px)`,heat:e=>`brightness(${1+e/100*2})`},a={none:0,chrome:1,sepia:2,marvin:3,phobos:4,heat:5};let i,d;n.style.cursor="ew-resize",r.style.display="none";const u=e=>{n.style.left=e+"%",r.querySelector(".effect-level__depth").style.width=e+"%",s.value=e};document.querySelector(".img-upload__form").addEventListener("change",(r=>{d=100,s.value=d,e.className="img-upload__preview effects__preview--none",r.target&&r.target.matches('input[type="radio"]')&&(t.forEach((e=>{e.style.border="none"})),o.forEach((e=>{e.style.color="white"})),c[r.target.value](),t[a[r.target.value]].style.border="#ffe753",o[a[r.target.value]].style.color="#ffe753",u(d),s.value=""+d),i=r.target.value})),n.addEventListener("mousedown",(t=>{t.preventDefault();let o={x:t.clientX};const r=e=>{e.preventDefault();let t=o.x-e.clientX;o={x:e.clientX},d=(n.offsetLeft-t)/452.5*100,d>100?d=100:d<0&&(d=0),u(d)},s=t=>{u(d),t.preventDefault(),e.style.filter=l[i](d),n.removeEventListener("mousemove",r),n.removeEventListener("mouseup",s)};n.addEventListener("mousemove",r),n.addEventListener("mouseup",s)})),window.cancelOldValues=()=>{e.style.filter="none",r.style.display="none",document.querySelector(".text__hashtags").value="",document.querySelector(".text__description").value="",d=100,t.forEach((e=>{e.style.border="none"})),o.forEach((e=>{e.style.color="white"})),t[0].style.border="#ffe753",o[0].style.color="#ffe753"}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),o=t.querySelector(".success__button"),r=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),s=r.querySelector(".error__button"),n=(t,o,r,s,n)=>{e.append(t),o.addEventListener("click",r),document.addEventListener("keydown",s),document.addEventListener("click",n)},c=(e,t,o)=>{e.remove(),document.removeEventListener("keydown",t),document.removeEventListener("click",o)},l=()=>{c(t,a,i)},a=e=>{window.util.isEscape(e)&&(e.preventDefault(),c(t,a,i))},i=e=>{e.preventDefault(),c(t,a,i)},d=()=>{c(r,u,m)},u=e=>{window.util.isEscape(e)&&(e.preventDefault(),c(r,u,m))},m=e=>{e.preventDefault(),c(r,u,m)};window.successError={openSuccessMessage:()=>{n(t,o,l,a,i)},openErrorMessage:()=>{n(r,s,d,u,m)}}})(),(()=>{const e=document.querySelector(".img-upload__form"),t=e.querySelector("#upload-file"),o=e.querySelector("#upload-cancel"),r=e.querySelector(".img-upload__overlay"),s=r.querySelector(".text__hashtags"),n=r.querySelector(".text__description");t.addEventListener("change",(()=>{window.cancelOldValues(),r.classList.remove("hidden")}));const c=e=>{window.util.isEscape(e)&&e.target!==s&&e.target!==n&&(e.preventDefault(),r.classList.add("hidden"))};o.addEventListener("click",(()=>{window.cancelOldValues(),r.classList.add("hidden"),document.removeEventListener("keydown",c),t.value=""})),document.addEventListener("keydown",c);const l=/^\s*#*\w*$/,a=n.value;e.addEventListener("submit",(t=>{const o=s.value.split(" "),c=new Set;for(let e of o)c.add(e.toLowerCase());const i=c.size<o.length,d=o.some((e=>!l.test(e))),u=o.some((e=>e.length>20));d||o.length>5?(s.setCustomValidity("Строка после решётки должна состоять из букв и чисел и не может содержать пробелы, спецсимволы (#, @, $ и т. п.), символы пунктуации (тире, дефис, запятая и т. п.), эмодзи и т. д. Нельзя указать больше пяти хэш-тегов."),t.preventDefault()):i?(s.setCustomValidity("Хэш-теги нечувствительны к регистру: #ХэшТег и #хэштег считаются одним и тем же тегом. Один и тот же хэш-тег не может быть использован дважды."),t.preventDefault()):u?(s.setCustomValidity("Минимальная длина одного хэш-тега – 2 символа, максимальная длина – 20 символов, включая решётку."),t.preventDefault()):a.length>140?(n.setCustomValidity(`Максимальная длина комментария 140 символов. Удалите лишние ${a.length-140} симв.`),t.preventDefault()):(window.backend.save(new FormData(e),(()=>{r.classList.add("hidden")})),t.preventDefault(),window.successError.openSuccessMessage())}))})(),window.backend.load(window.successHandler,window.util.createErrorMessage)})();