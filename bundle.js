(()=>{"use strict";(()=>{const e=(e,t)=>Math.floor(e+Math.random()*(t+1-e));window.util={isEscape:e=>"Escape"===e.key,isEnter:e=>"Enter"===e.key,getRandom:e,getRandomFrom:t=>t[e(0,t.length-1)],shuffleElements:e=>{for(let t=e.length-1;t>0;t--){const o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}return e}}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e="https://21.javascript.pages.academy/kekstagram/data",t="https://21.javascript.pages.academy/kekstagram",o={400:"Неверный запрос",401:"Пользователь не авторизован",404:"Ничего не найдено"},r=(e,t,r,s,n)=>{const l=new XMLHttpRequest;l.responseType="json",l.addEventListener("load",((e,t,r)=>()=>{let s;switch(e.status){case 200:t(e.response);break;case e.status:s=o[e.status];break;default:s="Cтатус ответа: : "+e.status+" "+e.statusText}s&&r(s)})(l,t,r)),l.timeout=5e3,l.addEventListener("timeout",(()=>{r("Запрос не успел выполниться за "+l.timeout+"мс")})),l.addEventListener("error",(()=>{window.successError.openErrorMessage()})),l.open(e,s),l.send(n)};window.backend={load:(t,o)=>{r("GET",t,o,e)},save:(e,o,s)=>{r("POST",o,s,t,e)}}})(),(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector(".comments-loader"),o=e.querySelector(".social__comments"),r=e.querySelector("#picture-cancel"),s=o.querySelector(".social__comment").cloneNode(!0),n=e=>{const t=s.cloneNode(!0);return t.querySelector(".social__picture").src=e.avatar,t.querySelector(".social__picture").alt=e.name,t.querySelector(".social__picture").width="35",t.querySelector(".social__picture").height="35",t.querySelector(".social__text").textContent=e.message,t.classList.add("hidden"),t};window.renderBigPicture=s=>{e.querySelector("img").src=s.url,e.querySelector("img").alt=s.description,e.querySelector(".social__caption").textContent=s.description,e.querySelector(".likes-count").textContent=s.likes,e.querySelector(".comments-count").textContent=s.comments.length,o.innerHTML="",s.comments.map(n).forEach((e=>o.append(e))),t.classList.remove("hidden");let l=[];l=s.comments;const c=(e,t)=>{for(let o=0;o<e;o++)t[o].classList.remove("hidden")},i=o.querySelectorAll(".social__comment");let a=5;const d=(e,o,r)=>{e<o.length?(c(e,r),t.classList.remove("hidden")):(c(o.length,r),t.classList.add("hidden"))};d(a,i,i),t.addEventListener("click",(()=>{a+=5,d(a,l,i)})),e.querySelector(".social__comment-count").classList.add("hidden"),document.querySelector("body").classList.add("modal-open"),e.classList.remove("hidden");const u=t=>{window.util.isEscape(t)&&document.querySelector("body").classList.remove("modal-open"),e.classList.add("hidden")};return r.addEventListener("click",(()=>{e.classList.add("hidden"),document.removeEventListener("keydown",u),document.querySelector("body").classList.remove("modal-open")})),document.addEventListener("keydown",u),e}})(),(()=>{const e=document.querySelector("#picture").content.querySelector(".picture");window.renderPicture=t=>{const o=e.cloneNode(!0);return o.querySelector(".picture__img").src=t.url,o.querySelector(".picture__likes").textContent=t.likes,o.querySelector(".picture__comments").textContent=t.comments.length,o}})(),(()=>{const e=document.querySelector("body"),t=document.querySelector(".pictures"),o=document.querySelector(".img-filters"),r=o.querySelectorAll(".img-filters__button"),s=e=>{let t=0;return t+=e.comments.length,t},n=o=>{(e=>{const o=document.createDocumentFragment();e.map(window.renderPicture).forEach((e=>o.append(e))),t.append(o)})(o),e.classList.remove("modal-open"),((e,t)=>{for(let o=0;o<e.length;o++)e[o].addEventListener("click",(()=>{window.renderBigPicture(t[o])}))})(t.querySelectorAll(".picture"),o)},l=window.debounce(n),c={"filter-default":e=>{const t=(e=>e.slice())(e);a(),i(r),l(t)},"filter-random":e=>{const t=((e,t)=>window.util.shuffleElements(e.slice()).slice(0,10))(e);a(),i(r),l(t)},"filter-discussed":e=>{const t=(e=>e.slice().sort(((e,t)=>s(t)-s(e))))(e);a(),i(r),l(t)}},i=e=>{for(let t of e)t.classList.remove("img-filters__button--active")},a=()=>{t.querySelectorAll(".picture").forEach((e=>e.remove())),e.classList.remove("modal-open")};let d=[];window.successHandler=e=>{d=e,n(d),o.classList.remove("img-filters--inactive"),(e=>{for(let t of r)t.addEventListener("click",(o=>{c[o.target.id](e),t.classList.add("img-filters__button--active")}))})(d)}})(),(()=>{const e=document.querySelector(".img-upload__scale"),t=e.querySelector(".scale__control--smaller"),o=e.querySelector(".scale__control--bigger"),r=e.querySelector(".scale__control--value"),s=document.querySelector(".img-upload__preview img"),n=e=>{r.setAttribute("value",e+"%"),s.style.transform=`scale(${e/100})`};n(100),t.addEventListener("click",(()=>{const e=r.value,t=parseInt(e,10)-25;t>=25?n(t):r.setAttribute("value","25%")})),o.addEventListener("click",(()=>{const e=r.value,t=parseInt(e,10)+25;t<=100?n(t):r.setAttribute("value","100%")}))})(),(()=>{const e=document.querySelector(".img-upload__preview"),t=document.querySelectorAll(".effects__preview"),o=document.querySelectorAll(".effects__label"),r=document.querySelector(".img-upload__effect-level"),s=r.querySelector(".effect-level__value"),n=document.querySelector(".effect-level__pin"),l={none:()=>{a="none",e.classList.add("effects__preview--none"),r.style.display="none",e.style.filter="none"},chrome:()=>{a="chrome",e.classList.add("effects__preview--chrome"),e.style.filter="grayscale(1)",r.style.display="block"},sepia:()=>{a="sepia",e.classList.add("effects__preview--sepia"),e.style.filter="sepia(1)",r.style.display="block"},marvin:()=>{a="marvin",e.classList.add("effects__preview--marvin"),e.style.filter="invert(100%)",r.style.display="block"},phobos:()=>{a="phobos",e.classList.add("effects__preview--phobos"),e.style.filter="blur(3px)",r.style.display="block"},heat:()=>{a="heat",e.classList.add("effects__preview--heat"),e.style.filter="brightness(3)",r.style.display="block"}},c={none:()=>"none",chrome:e=>`grayscale(${e/100})`,sepia:e=>`sepia(${e/100})`,marvin:e=>`invert(${e}%)`,phobos:e=>`blur(${1+e/100*2}px)`,heat:e=>`brightness(${1+e/100*2})`},i={none:0,chrome:1,sepia:2,marvin:3,phobos:4,heat:5};let a,d;n.style.cursor="ew-resize",r.style.display="none";const u=e=>{n.style.left=e+"%",r.querySelector(".effect-level__depth").style.width=e+"%",s.value=e};document.querySelector(".img-upload__form").addEventListener("change",(r=>{d=100,s.value=d,e.className="img-upload__preview effects__preview--none",r.target&&r.target.matches('input[type="radio"]')&&(t.forEach((e=>{e.style.border="none"})),o.forEach((e=>{e.style.color="white"})),l[r.target.value](),t[i[r.target.value]].style.border="#ffe753",o[i[r.target.value]].style.color="#ffe753",u(d),s.value=""+d),a=r.target.value})),n.addEventListener("mousedown",(t=>{t.preventDefault();let o={x:t.clientX};const r=e=>{e.preventDefault();let t=o.x-e.clientX;o={x:e.clientX};const r=parseFloat(window.getComputedStyle(document.querySelector(".effect-level__line")).width);d=(n.offsetLeft-t)/r*100,d>100?d=100:d<0&&(d=0),u(d)},s=t=>{u(d),t.preventDefault(),e.style.filter=c[a](d),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",s)})),window.cancelOldValues=()=>{document.querySelector(".text__hashtags").style.outline="none",document.querySelector(".text__description").style.outline="none",document.querySelector("#upload-file").value="",e.style.filter="none",r.style.display="none",document.querySelector(".text__hashtags").value="",document.querySelector(".text__description").value="",d=100,document.querySelector(".scale__control--value").setAttribute("value","100%"),e.querySelector("img").style.transform="scale(1)",t.forEach((e=>{e.style.border="none"})),o.forEach((e=>{e.style.color="white"})),t[0].style.border="#ffe753",o[0].style.color="#ffe753"}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),o=t.querySelector(".success__button"),r=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),s=r.querySelector(".error__button"),n=r.querySelector(".error__title"),l=(t,o,r,s,n)=>{e.append(t),o.addEventListener("click",r),document.addEventListener("keydown",s),document.addEventListener("click",n)},c=(e,t,o)=>{e.remove(),document.removeEventListener("keydown",t),document.removeEventListener("click",o)},i=()=>{c(t,a,d)},a=e=>{window.util.isEscape(e)&&(e.preventDefault(),c(t,a,d))},d=e=>{e.preventDefault(),c(t,a,d)},u=()=>{c(r,m,p)},m=e=>{window.util.isEscape(e)&&(e.preventDefault(),c(r,m,p))},p=e=>{e.preventDefault(),c(r,m,p)};window.successError={openSuccessMessage:()=>{l(t,o,i,a,d)},openCreatedErrorMessage:t=>{((t,o,r,s,l,c)=>{n.textContent=t,e.append(o),r.addEventListener("click",s),document.addEventListener("keydown",l),document.addEventListener("click",c)})(t,r,s,u,m,p)},openErrorMessage:()=>{l(r,s,u,m,p)}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".img-upload__form"),o=t.querySelector("#upload-file"),r=t.querySelector("#upload-cancel"),s=t.querySelector(".img-upload__overlay"),n=s.querySelector(".text__hashtags"),l=s.querySelector(".text__description"),c=document.querySelector(".img-upload__start input[type=file]"),i=document.querySelector(".img-upload__preview img");let a=!0;c.addEventListener("change",(()=>{const t=c.files[0],o=t.name.toLowerCase();if(i.src="",a=e.some((e=>o.endsWith(e))),a){const e=new FileReader;e.addEventListener("load",(()=>{i.src=e.result})),e.addEventListener("error",window.successError.openErrorMessage),e.readAsDataURL(t)}}));const d=e=>{window.util.isEscape(e)&&e.target!==n&&e.target!==l&&(e.preventDefault(),window.cancelOldValues(),s.classList.add("hidden")),document.removeEventListener("keydown",d),r.removeEventListener("click",u)},u=()=>{window.cancelOldValues(),s.classList.add("hidden"),document.removeEventListener("keydown",d),r.removeEventListener("click",u)};o.addEventListener("change",(()=>{s.classList.remove("hidden"),r.addEventListener("click",u),document.addEventListener("keydown",d)})),n.addEventListener("input",(e=>{const t=/^\s*#\w*$/,o=n.value,r=o.split(" "),s=new Set;for(let e of r)s.add(e.toLowerCase());const l=s.size<r.length,c=""!==o&&r.some((e=>!t.test(e))),i=r.some((e=>e.length>20)),a=""!==o&&r.some((e=>e.length<2));e.preventDefault(),c||r.length>5?(n.style.outline="2px solid red",n.setCustomValidity("Строка после решётки должна состоять из букв и чисел и не может содержать пробелы, спецсимволы (#, @, $ и т. п.), символы пунктуации (тире, дефис, запятая и т. п.), эмодзи и т. д. Нельзя указать больше пяти хэш-тегов.")):l?(n.style.outline="2px solid red",n.setCustomValidity("Хэш-теги нечувствительны к регистру: #ХэшТег и #хэштег считаются одним и тем же тегом. Один и тот же хэш-тег не может быть использован дважды.")):i||a?(n.style.outline="2px solid red",n.setCustomValidity("Минимальная длина одного хэш-тега – 2 символа, максимальная длина – 20 символов, включая решётку.")):(n.setCustomValidity(""),n.style.outline="none"),n.reportValidity()})),l.addEventListener("input",(e=>{const t=l.value,o=t.length>140;e.preventDefault(),o?(l.setCustomValidity(`Максимальная длина комментария 140 символов. Удалите лишние ${t.length-140} симв.`),l.style.outline="2px solid red"):(l.setCustomValidity(""),l.style.outline="none"),l.reportValidity()})),t.addEventListener("submit",(e=>{e.preventDefault(),a?window.backend.save(new FormData(t),(()=>{s.classList.add("hidden"),window.cancelOldValues(),window.successError.openSuccessMessage()})):(s.classList.add("hidden"),window.successError.openErrorMessage()),t.reportValidity()}))})(),window.backend.load(window.successHandler,window.successError.openCreatedErrorMessage)})();